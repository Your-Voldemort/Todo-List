{% extends "base.html" %}

{% block title %}Dashboard - TodoApp{% endblock %}

{% block content %}
<div class="mb-8 animate-fade-in">
    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Dashboard</h1>
    <p class="text-gray-600 dark:text-gray-400">Overview of your productivity and task statistics</p>
</div>

<!-- Quick Stats -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 animate-slide-down">
    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-lg p-6 text-white transform hover:scale-105 transition-transform">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm opacity-90">Total Tasks</p>
                <p class="text-4xl font-bold mt-2">{{ stats.total }}</p>
            </div>
            <div class="p-3 bg-white bg-opacity-20 rounded-full">
                <i class="fas fa-tasks text-3xl"></i>
            </div>
        </div>
    </div>

    <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-lg p-6 text-white transform hover:scale-105 transition-transform">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm opacity-90">Completed</p>
                <p class="text-4xl font-bold mt-2">{{ stats.completed }}</p>
            </div>
            <div class="p-3 bg-white bg-opacity-20 rounded-full">
                <i class="fas fa-check-circle text-3xl"></i>
            </div>
        </div>
        <div class="mt-4 pt-4 border-t border-white border-opacity-20">
            <div class="flex items-center justify-between text-sm">
                <span>Completion Rate</span>
                <span class="font-bold">{{ stats.completion_rate }}%</span>
            </div>
            <div class="mt-2 h-2 bg-white bg-opacity-20 rounded-full overflow-hidden">
                <div class="h-full bg-white rounded-full transition-all" style="width: {{ stats.completion_rate }}%"></div>
            </div>
        </div>
    </div>

    <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-lg shadow-lg p-6 text-white transform hover:scale-105 transition-transform">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm opacity-90">In Progress</p>
                <p class="text-4xl font-bold mt-2">{{ stats.pending }}</p>
            </div>
            <div class="p-3 bg-white bg-opacity-20 rounded-full">
                <i class="fas fa-spinner text-3xl"></i>
            </div>
        </div>
    </div>

    <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-lg shadow-lg p-6 text-white transform hover:scale-105 transition-transform">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm opacity-90">Overdue</p>
                <p class="text-4xl font-bold mt-2">{{ stats.overdue }}</p>
            </div>
            <div class="p-3 bg-white bg-opacity-20 rounded-full">
                <i class="fas fa-exclamation-triangle text-3xl"></i>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Priority Breakdown Chart -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 animate-slide-down">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
            <i class="fas fa-flag mr-2 text-primary"></i>
            Priority Breakdown
        </h2>
        <div class="h-64">
            <canvas id="priorityChart"></canvas>
        </div>
        <div class="mt-4 grid grid-cols-3 gap-4 text-center">
            <div>
                <p class="text-2xl font-bold text-red-600">{{ stats.high_priority }}</p>
                <p class="text-sm text-gray-600 dark:text-gray-400">High</p>
            </div>
            <div>
                <p class="text-2xl font-bold text-yellow-600">{{ stats.medium_priority }}</p>
                <p class="text-sm text-gray-600 dark:text-gray-400">Medium</p>
            </div>
            <div>
                <p class="text-2xl font-bold text-green-600">{{ stats.low_priority }}</p>
                <p class="text-sm text-gray-600 dark:text-gray-400">Low</p>
            </div>
        </div>
    </div>

    <!-- Category Distribution Chart -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 animate-slide-down">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
            <i class="fas fa-tags mr-2 text-primary"></i>
            Category Distribution
        </h2>
        <div class="h-64">
            <canvas id="categoryChart"></canvas>
        </div>
        {% if stats.categories %}
        <div class="mt-4 space-y-2">
            {% for category in stats.categories[:5] %}
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-3 h-3 rounded-full mr-2" style="background-color: {{ category.color }}"></div>
                    <span class="text-sm text-gray-700 dark:text-gray-300">{{ category.name }}</span>
                </div>
                <span class="text-sm font-bold text-gray-900 dark:text-white">{{ category.count }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Completion Trend -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8 animate-slide-down">
    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
        <i class="fas fa-chart-line mr-2 text-primary"></i>
        Weekly Completion Trend
    </h2>
    <div class="h-80">
        <canvas id="trendChart"></canvas>
    </div>
</div>

<!-- Recent Activity & Upcoming Tasks -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Recent Activity -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 animate-slide-down">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
            <i class="fas fa-history mr-2 text-primary"></i>
            Recent Activity
        </h2>
        <div class="space-y-4">
            {% for todo in recent_todos %}
            <div class="flex items-start space-x-3 pb-4 border-b border-gray-200 dark:border-gray-700 last:border-0">
                <div class="flex-shrink-0">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center
                        {% if todo.completed %}
                            bg-green-100 dark:bg-green-900
                        {% else %}
                            bg-blue-100 dark:bg-blue-900
                        {% endif %}">
                        <i class="fas {% if todo.completed %}fa-check text-green-600 dark:text-green-400{% else %}fa-plus text-blue-600 dark:text-blue-400{% endif %}"></i>
                    </div>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900 dark:text-white">
                        {{ todo.title }}
                    </p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                        {% if todo.completed %}
                            Completed {{ todo.updated_at.strftime('%b %d at %I:%M %p') }}
                        {% else %}
                            Created {{ todo.created_at.strftime('%b %d at %I:%M %p') }}
                        {% endif %}
                    </p>
                </div>
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                    {% if todo.priority == 'high' %}
                        bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200
                    {% elif todo.priority == 'medium' %}
                        bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200
                    {% else %}
                        bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200
                    {% endif %}">
                    {{ todo.priority }}
                </span>
            </div>
            {% else %}
            <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                <i class="fas fa-inbox text-4xl mb-2"></i>
                <p>No recent activity</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Upcoming Tasks -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 animate-slide-down">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
            <i class="fas fa-calendar-alt mr-2 text-primary"></i>
            Upcoming Deadlines
        </h2>
        <div class="space-y-4">
            {% for todo in upcoming_todos %}
            <div class="flex items-start space-x-3 pb-4 border-b border-gray-200 dark:border-gray-700 last:border-0">
                <div class="flex-shrink-0">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center
                        {% if todo.due_date < now %}
                            bg-red-100 dark:bg-red-900
                        {% else %}
                            bg-blue-100 dark:bg-blue-900
                        {% endif %}">
                        <i class="fas fa-calendar
                            {% if todo.due_date < now %}
                                text-red-600 dark:text-red-400
                            {% else %}
                                text-blue-600 dark:text-blue-400
                            {% endif %}"></i>
                    </div>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900 dark:text-white">
                        {{ todo.title }}
                    </p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                        <i class="fas fa-clock mr-1"></i>
                        Due {{ todo.due_date.strftime('%b %d, %Y') }}
                        {% if todo.due_date < now %}
                            <span class="text-red-600 dark:text-red-400 font-semibold">(Overdue)</span>
                        {% endif %}
                    </p>
                    {% if todo.category %}
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium mt-1"
                          style="background-color: {{ todo.category.color }}20; color: {{ todo.category.color }};">
                        {{ todo.category.name }}
                    </span>
                    {% endif %}
                </div>
                <a href="{{ url_for('edit_todo', id=todo.id) }}" class="text-primary hover:text-blue-600 dark:text-blue-400">
                    <i class="fas fa-arrow-right"></i>
                </a>
            </div>
            {% else %}
            <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                <i class="fas fa-calendar-check text-4xl mb-2"></i>
                <p>No upcoming deadlines</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Priority Breakdown Pie Chart
    const priorityCtx = document.getElementById('priorityChart').getContext('2d');
    const priorityChart = new Chart(priorityCtx, {
        type: 'doughnut',
        data: {
            labels: ['High Priority', 'Medium Priority', 'Low Priority'],
            datasets: [{
                data: [{{ stats.high_priority }}, {{ stats.medium_priority }}, {{ stats.low_priority }}],
                backgroundColor: [
                    'rgba(239, 68, 68, 0.8)',
                    'rgba(234, 179, 8, 0.8)',
                    'rgba(34, 197, 94, 0.8)'
                ],
                borderColor: [
                    'rgba(239, 68, 68, 1)',
                    'rgba(234, 179, 8, 1)',
                    'rgba(34, 197, 94, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151'
                    }
                }
            }
        }
    });

    // Category Distribution Pie Chart
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    const categoryChart = new Chart(categoryCtx, {
        type: 'pie',
        data: {
            labels: {{ stats.category_labels|tojson }},
            datasets: [{
                data: {{ stats.category_data|tojson }},
                backgroundColor: {{ stats.category_colors|tojson }},
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151'
                    }
                }
            }
        }
    });

    // Weekly Trend Line Chart
    const trendCtx = document.getElementById('trendChart').getContext('2d');
    const trendChart = new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: {{ stats.trend_labels|tojson }},
            datasets: [{
                label: 'Completed Tasks',
                data: {{ stats.trend_data|tojson }},
                borderColor: 'rgba(59, 130, 246, 1)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151'
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        color: document.documentElement.classList.contains('dark') ? '#9ca3af' : '#6b7280'
                    },
                    grid: {
                        color: document.documentElement.classList.contains('dark') ? '#374151' : '#e5e7eb'
                    }
                },
                x: {
                    ticks: {
                        color: document.documentElement.classList.contains('dark') ? '#9ca3af' : '#6b7280'
                    },
                    grid: {
                        color: document.documentElement.classList.contains('dark') ? '#374151' : '#e5e7eb'
                    }
                }
            }
        }
    });

    // Update charts when dark mode is toggled
    document.getElementById('darkModeToggle').addEventListener('click', () => {
        setTimeout(() => {
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';
            const gridColor = isDark ? '#374151' : '#e5e7eb';

            [priorityChart, categoryChart, trendChart].forEach(chart => {
                if (chart.options.plugins.legend) {
                    chart.options.plugins.legend.labels.color = textColor;
                }
                if (chart.options.scales) {
                    chart.options.scales.y.ticks.color = textColor;
                    chart.options.scales.y.grid.color = gridColor;
                    chart.options.scales.x.ticks.color = textColor;
                    chart.options.scales.x.grid.color = gridColor;
                }
                chart.update();
            });
        }, 100);
    });
</script>
{% endblock %}
